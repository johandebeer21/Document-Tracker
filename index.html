<script>
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/1ZTJWdmeVqziiFBVj3MVB1d03_7bKPEmiYuG8xkIInco/gviz/tq?tqx=out:csv';

  // Use AllOrigins to bypass CORS
  const PROXIED_CSV_URL = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(CSV_URL);

  // Simple CSV parser
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines.shift().split(',');
    return lines.map(line => {
      const data = line.split(',');
      const obj = {};
      headers.forEach((h, i) => obj[h.trim()] = data[i] ? data[i].trim() : '');
      return obj;
    });
  }

  const appList = document.getElementById('app-list');
  const searchInput = document.getElementById('search');
  let applications = [];

  function renderApps(list) {
    if (!list.length) {
      appList.innerHTML = '<p>No applications found.</p>';
      return;
    }
    appList.innerHTML = '';
    list.forEach((app, i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.style.animationDelay = `${i * 0.1}s`;

      card.innerHTML = `
        <h2>${app['Applicant Name']}</h2>
        <p>Submitted: ${app['Date Submitted'] || 'N/A'}</p>
        <p>${app['Notes'] || ''}</p>
        <span class="status ${app['Status']}">${app['Status'] || 'Pending'}</span>
      `;
      appList.appendChild(card);
    });
  }

  function fetchData() {
    appList.textContent = 'Loading data...';
    fetch(PROXIED_CSV_URL)
      .then(res => res.text())
      .then(text => {
        applications = parseCSV(text);
        renderApps(applications);
      })
      .catch(err => {
        appList.textContent = 'Failed to load data.';
        console.error(err);
      });
  }

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase();
    const filtered = applications.filter(app => app['Applicant Name'].toLowerCase().includes(term));
    renderApps(filtered);
  });

  fetchData();
  setInterval(fetchData, 60000); // Refresh every 60 seconds
</script>
